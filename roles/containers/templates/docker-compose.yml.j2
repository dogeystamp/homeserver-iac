# vim: ft=yaml
---

version: "3"

networks:
  gitea:
    driver: bridge
  navidrome:
    driver: bridge

services:
{% if "gitea" in group_names %}
  gitea:
    container_name: gitea
    image: gitea/gitea:latest
    environment:
      - USER=gitea
      - USER_UID={{ user_gitea.uid }}
      - USER_GID={{ user_gitea.group }}
      - GITEA__service__DISABLE_REGISTRATION=true
      - GITEA__server__DOMAIN={{ gitea_domain }}
      - GITEA__server__SSH_DOMAIN={{ gitea_domain }}
    ports:
      - "3000:3000"
      - "2498:22"
    restart: unless-stopped
    volumes:
      - {{ dataroot }}/gitea:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - gitea

{% endif %}
{% if "syncthing" in group_names %}
  syncthing:
    network_mode: host
    container_name: syncthing
    image: syncthing/syncthing
    environment:
      - PUID={{ user_syncthing.uid }}
      - PGID={{ user_syncthing.group }}
    restart: unless-stopped
    volumes:
      - {{ vault_path }}/:/vault
      - {{ archive_path }}/:/vault_a
      - {{ syncthing_conf_dir }}/:/var/syncthing/config

{% endif %}
{% if "navidrome" in group_names %}
  navidrome:
    container_name: navidrome
    image: deluan/navidrome:latest
    user: {{ user_navidrome.uid }}:{{ user_navidrome.group }}
    environment:
      ND_LISTENBRAINZ_ENABLED: true
    restart: unless-stopped
    volumes:
      - "{{ dataroot }}/navidrome:/data"
      - "{{ music_path }}/:/music:ro"
    networks:
      - navidrome
    ports:
      - "4533:4533"

{% endif %}
{% if "synapse" in group_names %}
  synapse:
    container_name: synapse
    image: matrixdotorg/synapse:latest
    user: {{ user_synapse.uid }}:{{ user_synapse.group }}
    environment:
      SYNAPSE_CONFIG_PATH: /data/homeserver.yaml
    restart: unless-stopped
    volumes:
      - "{{ dataroot }}/synapse/media_store:/data/media_store"
      - "{{ dataroot }}/synapse/data:/data"
    networks:
      - navidrome
    ports:
      - "8008:8008/tcp"

{% endif %}
